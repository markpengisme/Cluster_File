package com.jpmorgan.cakeshop.client.test.api;

import static org.testng.Assert.*;

import com.jpmorgan.cakeshop.client.api.BlockApi;
import com.jpmorgan.cakeshop.client.model.Block;
import com.jpmorgan.cakeshop.client.model.req.BlockGetCommand;
import com.jpmorgan.cakeshop.client.model.res.APIData;
import com.jpmorgan.cakeshop.client.model.res.APIResponse;

import org.testng.annotations.Test;

import okhttp3.mockwebserver.MockResponse;

public class BlockApiTest extends BaseApiTest {

    @Test
    public void testBlockGet() {
        BlockApi blockApi = apiClient.buildClient(BlockApi.class);
        String hash = "0xb858713990d2d43cb86b9c96d14156ffab8dcd579d0b33ef00d21ec660bdc8bf";

        mockWebServer.enqueue(new MockResponse().setBody("{\"data\":{\"id\":\"0xb858713990d2d43cb86b9c96d14156ffab8dcd579d0b33ef00d21ec660bdc8bf\",\"type\":\"block\",\"attributes\":{\"id\":\"0xb858713990d2d43cb86b9c96d14156ffab8dcd579d0b33ef00d21ec660bdc8bf\",\"parentId\":\"0x0eb6c95969c36df9144d8882c073cac591eb57680f21d41cb388c3276e38f968\",\"number\":4,\"nonce\":\"0x000000000000002a\",\"sha3Uncles\":\"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\"logsBloom\":\"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"transactionsRoot\":\"0xcbeadbc82fde7ff88e8ff403a63e6a2ac1820d1ce2cd348bf9e38ec27542c4d0\",\"stateRoot\":\"0xa13c73e0e38d05f98079f13d869bbe5f486458ff449efef7147e5bdcd6be6d26\",\"miner\":\"0x2e219248f44546d966808cdd20cb6c36df6efa82\",\"difficulty\":131072,\"totalDifficulty\":525376,\"extraData\":\"0xd883010403844765746887676f312e352e328664617277696e\",\"gasLimit\":134217728,\"gasUsed\":26624,\"timestamp\":1464365362,\"transactions\":[\"0x868e24c5d213f3cef0026120b330a3884c68b941f635ab2486685f17a607b0d8\"],\"uncles\":[]}},\"meta\":{\"version\":\"1.0\"}}"));
        APIResponse<APIData<Block>, Block> res = blockApi.get(new BlockGetCommand().id(hash));
        commonTests(res, hash, 4L);


        mockWebServer.enqueue(new MockResponse().setBody("{\"data\":{\"id\":\"0xd93b8da4c2f48c98e2cb76bef403ec22cada28331946218487b0fd1335e52bdd\",\"type\":\"block\",\"attributes\":{\"id\":\"0xd93b8da4c2f48c98e2cb76bef403ec22cada28331946218487b0fd1335e52bdd\",\"parentId\":\"0x0000000000000000000000000000000000000000000000000000000000000000\",\"number\":0,\"nonce\":\"0xdeadbeefdeadbeef\",\"sha3Uncles\":\"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\"logsBloom\":\"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"transactionsRoot\":\"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421\",\"stateRoot\":\"0x43efc4efe80097410e2d76b3e20ad345a8eef140bf9b0d5afca4bc064bcd5aa6\",\"miner\":\"0x3333333333333333333333333333333333333333\",\"difficulty\":1024,\"totalDifficulty\":1024,\"extraData\":\"0x686f727365\",\"gasLimit\":134217728,\"gasUsed\":0,\"timestamp\":0,\"transactions\":[],\"uncles\":[]}},\"meta\":{\"version\":\"1.0\"}}"));
        res = blockApi.get(new BlockGetCommand().number(0L));
        commonTests(res, "0xd93b8da4c2f48c98e2cb76bef403ec22cada28331946218487b0fd1335e52bdd", 0L);


        mockWebServer.enqueue(new MockResponse().setBody("{\"data\":{\"id\":\"0xb858713990d2d43cb86b9c96d14156ffab8dcd579d0b33ef00d21ec660bdc8bf\",\"type\":\"block\",\"attributes\":{\"id\":\"0xb858713990d2d43cb86b9c96d14156ffab8dcd579d0b33ef00d21ec660bdc8bf\",\"parentId\":\"0x0eb6c95969c36df9144d8882c073cac591eb57680f21d41cb388c3276e38f968\",\"number\":4,\"nonce\":\"0x000000000000002a\",\"sha3Uncles\":\"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347\",\"logsBloom\":\"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"transactionsRoot\":\"0xcbeadbc82fde7ff88e8ff403a63e6a2ac1820d1ce2cd348bf9e38ec27542c4d0\",\"stateRoot\":\"0xa13c73e0e38d05f98079f13d869bbe5f486458ff449efef7147e5bdcd6be6d26\",\"miner\":\"0x2e219248f44546d966808cdd20cb6c36df6efa82\",\"difficulty\":131072,\"totalDifficulty\":525376,\"extraData\":\"0xd883010403844765746887676f312e352e328664617277696e\",\"gasLimit\":134217728,\"gasUsed\":26624,\"timestamp\":1464365362,\"transactions\":[\"0x868e24c5d213f3cef0026120b330a3884c68b941f635ab2486685f17a607b0d8\"],\"uncles\":[]}},\"meta\":{\"version\":\"1.0\"}}"));
        res = blockApi.get(new BlockGetCommand().tag("latest"));
        commonTests(res, hash, 4L);
    }

    private void commonTests(APIResponse<APIData<Block>, Block> res, String hash, Long num) {
        assertNotNull(res);
        Block block = res.getData();
        assertNotNull(block);
        assertEquals(block.getId(), hash);
        assertEquals(block.getNumber(), Long.valueOf(num));
    }

}
